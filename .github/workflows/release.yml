name: Release builds

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            os_name: linux
            arch: x86_64
            use_cross: false
          - runner: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            os_name: linux
            arch: aarch64
            use_cross: true
          - runner: macos-13
            target: x86_64-apple-darwin
            os_name: macos
            arch: x86_64
            use_cross: false
          - runner: macos-14
            target: aarch64-apple-darwin
            os_name: macos
            arch: aarch64
            use_cross: false
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
            os_name: windows
            arch: x86_64
            use_cross: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Install cross
        if: ${{ matrix.use_cross }}
        uses: taiki-e/install-action@v2
        with:
          tool: cross
      - name: Build release
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ matrix.use_cross }}" == "true" ]]; then
            cross build --release --target "${{ matrix.target }}"
          else
            cargo build --release --target "${{ matrix.target }}"
          fi
      - name: Package
        shell: bash
        run: |
          set -euo pipefail
          version=$(python -c "import tomllib; from pathlib import Path; data = tomllib.loads(Path('Cargo.toml').read_text()); print(data['package']['version'])")
          os="${{ matrix.os_name }}"
          arch="${{ matrix.arch }}"
          bin_name="neatify"
          bin_ext=""
          if [[ "$os" == "windows" ]]; then
            bin_ext=".exe"
          fi
          mkdir -p dist
          cp "target/${{ matrix.target }}/release/${bin_name}${bin_ext}" "dist/${bin_name}${bin_ext}"
          if [[ "$os" == "windows" ]]; then
            powershell -NoProfile -Command "Compress-Archive -Path dist/${bin_name}${bin_ext} -DestinationPath dist/${bin_name}-${version}-${os}-${arch}.zip"
          else
            tar -czf "dist/${bin_name}-${version}-${os}-${arch}.tar.gz" -C dist "${bin_name}${bin_ext}"
          fi
      - name: Upload release assets
        if: ${{ github.event_name == 'release' }}
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
      - name: Upload build artifacts
        if: ${{ github.event_name != 'release' }}
        uses: actions/upload-artifact@v4
        with:
          name: neatify-${{ matrix.os_name }}-${{ matrix.arch }}
          path: dist/*
